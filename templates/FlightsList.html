{% extends 'base.html' %}
{% load static %}

{% block title %}flights_list{% endblock %}
{% block extra_head %} 
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link rel="stylesheet" href="{% static 'css/FlightsList.css' %}">
 {% endblock %}
    
    
{% block content %}

<body>
    <section class="hero"> 
        <div class="hero-title">
            <h1>Everywhere we go ,<br> makes us everything we are</h1>
           
        </div>
    
        
        </section> 
        <section class="layout">
      
            <!-- FILTER MENU (Left Column) -->
            <div class="filter-wrapper">
            <div  class="filter-menu ">
              <div class="filter-header">
                <h3>Filter</h3>
                <button id="reset-button">Reset</button>
              </div>
              <script>
                document.getElementById('reset-button').addEventListener('click', function () {
                  document.getElementById('selected-flight-class').value = '';
                  document.getElementById('hidden-min-price').value = '';
                  document.getElementById('hidden-max-price').value = '';
                  document.getElementById('selected-stops').value = '';
              
                  // Uncheck all airline checkboxes (if using them)
                  document.querySelectorAll('.airline-filter').forEach(cb => cb.checked = false);
              
                  document.getElementById('flight-type-form').requestSubmit();
                });
              </script>
          
              <!-- Search Summary -->
              <h3>Your Search Details</h3>
              <div class="search-summary">
                <p>From {{ from_city }} To {{ to_city }}</p>
                <p>{{ people }} {{ people|pluralize:"person,people" }}</p>
              </div>
              
              <form id="flight-type-form" hx-get="{% url 'flight-id-cards' %}" hx-target="#flight-cards" hx-swap="outerHTML">
                <input type="hidden" name="to_city" value="{{ to_city }}">
                <input type="hidden" name="from_city" value="{{ from_city }}">
                <input type="hidden" name="class" id="selected-flight-class">   
                <input type="hidden" name="min_price" id="hidden-min-price">
                <input type="hidden" name="max_price" id="hidden-max-price">
                <input type="hidden" name="stops" id="selected-stops">
                <input type="hidden" name="departure" id="selected-departure-date">
                <input type="hidden" name="return" id="selected-return-date">
                <input type="hidden" name="people" value="{{ people }}">
              

              <!-- Category -->
              <div class="class-section">
                <h4>Class</h4>
                <div class="filter-buttons">
                <button type="button" class="filter-option" onclick="document.getElementById('selected-flight-class').value='economy'; this.form.requestSubmit();">
                      Economy  </button>
                <button type="button" class="filter-option" onclick="document.getElementById('selected-flight-class').value='business'; this.form.requestSubmit();">
                      Business  </button>
                <button type="button" class="filter-option" onclick="document.getElementById('selected-flight-class').value='First Class'; this.form.requestSubmit();">
                     First Class  </button>
              </div>
              <!-- Price -->
             <h4>Price Range</h4>
           <div class="price-stepper">
            <div class="price-control">
              <label>Min Price</label>
              <div class="step-buttons">
                <button onclick="changePrice('min', -1000)">-</button>
                <span id="min-price">7000 DZD</span>
                <button onclick="changePrice('min', 1000)">+</button>
              </div>
            </div>
          
            <div class="price-control">
              <label>Max Price</label>
              <div class="step-buttons">
                <button onclick="changePrice('max', -1000)">-</button>
                <span id="max-price">15000 DZD</span>
                <button onclick="changePrice('max', 1000)">+</button>
              </div>
            </div>
          </div>
          <div class="button-price">
            <button id="apply-price">Apply price</button>
          </div>
          <script>
            let min = 7000;
           let max = 15000;
           const step = 1000;
           const minLimit = 1000;
           const maxLimit = 100000;

            function changePrice(type, value) {
               if (type === 'min') {
                min = Math.min(max - step, Math.max(min + value, minLimit));
               document.getElementById('min-price').textContent = `${min} DZD`;
              } else {
                 max = Math.max(min + step, Math.min(max + value, maxLimit));
                 document.getElementById('max-price').textContent = `${max} DZD`;
              }
               }
              document.getElementById('apply-price').addEventListener('click', function () {
                      document.getElementById('hidden-min-price').value = min;
                      document.getElementById('hidden-max-price').value = max;
                      document.getElementById('flight-type-form').requestSubmit(); // Uses HTMX!
              });
            

          </script>
          
              <!-- Stops -->
              <div class="Stop-section">
                <h4>Stops</h4>
                <div class="filter-buttons">
                  <button type="button" class="filter-option" onclick="document.getElementById('selected-stops').value='0'; this.form.requestSubmit();">
                    No Stop
                  </button>
                  <button type="button" class="filter-option" onclick="document.getElementById('selected-stops').value='1'; this.form.requestSubmit();">
                    1 Stop
                  </button>
                  <button type="button" class="filter-option" onclick="document.getElementById('selected-stops').value='2'; this.form.requestSubmit();">
                    +2 Stops
                  </button>
                </div>
              </div>


            <!-- Airlines -->
                <div class="airlines-section">
                 <h4>Airlines</h4>
                 <label> <input type="checkbox" class="airline-filter" name="airline_company[]" value="Emirates" />
                   <img src="/static/images/Emirates..jpg" alt="Emirates" width="30" height="30" style="vertical-align: middle; margin-right: 5px; margin-bottom: 5px;" >
                  Emirates </label><br>
                 <label> <input type="checkbox" class="airline-filter" name="airline_company[]" value="Algeria Airlines" /> 
                  <img src="/static/images/Algerie.png" alt="Algeria Airlines" width="30" height="30" style="vertical-align: middle; margin-right: 5px; margin-bottom: 5px;">
                  Algeria Airlines </label><br>
                 <label> <input type="checkbox" class="airline-filter" name="airline_company[]" value="British Airways"  /> 
                  <img src="/static/images/british-airways.png" alt="British Airways" width="30" height="30" style="vertical-align: middle; margin-right: 5px; margin-bottom: 5px;">
                  British Airways </label><br>
                 <label> <input type="checkbox" class="airline-filter" name="airline_company[]" value="Japan Airlines" /> 
                  <img src="/static/images/Japan.jpg" alt="JabanAirlines" width="" height="40" style="vertical-align: middle; margin-right: 5px;">
                  Japan Airlines </label>
                </div>
                <script>
                  document.querySelectorAll('.airline-filter').forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                      document.getElementById('flight-filter-form').requestSubmit();
                    });
                  });
                </script>
              <div class="button-container">
                <button type="button" id="apply-filters" onclick="document.getElementById('flight-type-form').requestSubmit();">Apply</button>
              </div>
           </form>
          </div>
           </div>
          </div>


          <div class="flights-container">
              <!-- Header -->
              <div class="flights-header">
                <div>Airline</div>
                <div>Departure</div>
                <div>Arrival</div>
                <div>Duration</div>
                <div>Price</div> <!-- Ajouté -->
              </div>

            
            <!-- Flight Card Container -->
           
         
                 <div class="flight-card-wrapper"  id="flight-cards">
                  {% for flight in flights %}
                   <div class="flight-card">

                  <!-- Airline -->
               <div class="flight-col airline">
                  <div class="outbound-label">
                    <span class="fas fa-plane-departure"></span> Flight
                  </div>
                  <div class="airline-logo-wrapper">
                    <img src="{{ flight.image.url }}" alt="{{ flight.airline_company }} Logo" class="airline-logo">
                  </div>
                  <div class="flight-info">{{ flight.airline_company }}</div>
              </div>

          <!-- Timeline -->
           <div class="flight-col timeline-section">
            <div class="timeline">
              <div class="timeline-row">

          <!-- Departure -->
          <div class="departure">
            <div class="city-code">{{ flight.departure_city }}</div>
            <div class="flight-time">{{ flight.departure_time|time:"h:i A" }}</div>
          </div>

          <!-- Timeline Line with Plane -->
          <div class="line">
            <span class="circle"></span>
            <span class="horizontal-line"></span>
            <i class="fas fa-plane icon-grey"></i>
            <span class="horizontal-line"></span>
            <span class="circle"></span>
          </div>

          <!-- Arrival -->
          <div class="arrival">
            <div class="city-code">{{ flight.arrival_city }}</div>
            <div class="flight-time">{{ flight.arrival_time|time:"h:i A" }}</div>
          </div>

             </div>
            </div>
          </div>

          <!-- Duration -->
                <div class="flight-col duration-section">
      <i class="fa-regular fa-clock icon-hour"></i>
      <div class="duration">{{ flight.formatted_duration }}</div>
           </div>

           <!-- Price -->
            <div class="flight-col price-box">
            <div class="seats-left">{{ flight.available_seats }} SEATS LEFT</div>
           <div class="price">{{ flight.price }} DZD</div>
          <div class="taxes">All taxes included</div>
          <button class="bookNowBtn"
             data-flight-id="{{ flight.id }}"
           data-airline="{{ flight.airline_company }}"
           data-departure-city="{{ flight.departure_city }}"
           data-departure-time="{{ flight.departure_time }}"
            data-arrival-city="{{ flight.arrival_city }}"
             data-arrival-time="{{ flight.arrival_time }}"
            data-duration="{{ flight.formatted_duration }}"
            data-available-seats="{{ flight.available_seats }}"
           data-price="{{ flight.price }}"
           data-image-url="{{ flight.image.url }}">
            Book Now
        </button>
    </div>

                   </div>
                   {% include 'form3.html' with flight=flight %}
                  {% empty %}
                  <p>No flights found for your search.</p>
                   {% endfor %}
                 </div>

            
          </div>
</section>

<script>
  // Flight Booking Modal Logic
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById('bookingModal');
  const bookNowButtons = document.querySelectorAll('.bookNowBtn');
  const closeBtn = document.getElementById('modalCloseBtn');
  document.getElementById("seat_count").addEventListener("input", calculateTotal);
  document.getElementById("class_type").addEventListener("change", calculateTotal);

  // Attach event to each 'Book Now' button
  bookNowButtons.forEach(button => {
    button.addEventListener('click', function () {
      const company = this.getAttribute('data-airline');
      const departureCity = this.getAttribute('data-departure-city');
      const departureTime = this.getAttribute('data-departure-time');
      const arrivalCity = this.getAttribute('data-arrival-city');
      const arrivalTime = this.getAttribute('data-arrival-time');
      const price = parseFloat(this.getAttribute('data-price'));

      // Fill flight summary details
      document.getElementById("companyName").textContent = company;
      document.getElementById("departureCity").textContent = departureCity;
      document.getElementById("departureTime").textContent = departureTime;
      document.getElementById("arrivalCity").textContent = arrivalCity;
      document.getElementById("arrivalTime").textContent = arrivalTime;

      // Set base price as value for calculation
      const finalAmountInput = document.getElementById("finalAmount");
      finalAmountInput.value = price.toFixed(2);
      finalAmountInput.setAttribute("data-base-price", price.toFixed(2));
      document.getElementById("totalPrice").textContent = price.toFixed(2) + "\u00A0DZD";

        // Reset form sections
        document.getElementById('bookingSummarySection').style.display = 'block';
        document.getElementById('infoSection').style.display = 'none';
    
        // Set default values
        document.getElementById("seat_count").value = 1;
        document.getElementById("class_type").value = "Economy";
    
        // Show modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    
        // Add listener for seat count and class type
        document.getElementById("seat_count").addEventListener("input", calculateTotal);
        document.getElementById("class_type").addEventListener("change", calculateTotal);
    });
  });

  // Modal Close
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    });
  }

  window.onclick = function (event) {
    if (event.target === modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  };

  // Coupon Application

  window.applyCoupon = function () {
    const coupon = document.getElementById("summaryCoupon").value.trim();
    fetch(`/validate-coupon/?code=${coupon}`)
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          alert(`Coupon appliqué ! ${data.discount}% de réduction.`);
          couponApplied = true;
          couponDiscount = data.discount; // ← stocke la valeur dynamique
          calculateTotal();
        } else {
          alert(data.message);
          couponApplied = false;
          couponDiscount = 0;
          calculateTotal();
        }
      });
  };
  
  

  let couponApplied = false;
  let couponDiscount = 0;

  // Calculate Total Price
  function calculateTotal() {
    const baseInput = document.getElementById("finalAmount");
    const basePrice = parseFloat(baseInput.getAttribute("data-base-price")) || 0;
  
    const seatCount = parseInt(document.getElementById("seat_count").value) || 1;
    const classType = document.getElementById("class_type").value;
   
  
    let classMultiplier = 1;
    if (classType === "Business") {
      classMultiplier = 1.5;
    } else if (classType === "First Class") {
      classMultiplier = 2;
    }
    let total = basePrice * classMultiplier * seatCount;

    const coupon = document.getElementById("summaryCoupon").value.trim();

    if (couponApplied) {
      total *= (1 - couponDiscount / 100);
    }
  
    document.getElementById("totalPrice").textContent = total.toFixed(2) + "\u00A0DZD";
    baseInput.value = total.toFixed(2); // Final amount to submit
  }
  
  

  // Dropdown Option for Class Type
  window.selectOption = function (value) {
    document.getElementById("class_type").value = value;
    calculateTotal();
  };

  // Move to Info Section
  window.showInfoSection = function () {
    document.getElementById('infoSection').style.display = 'flex';
    document.getElementById('bookingSummarySection').style.display = 'none';
  };

  // Success message fade-out (if exists)
  setTimeout(() => {
    const alert = document.querySelector('[style*="background-color: #d4edda"]');
    if (alert) {
      alert.style.transition = 'opacity 0.5s ease';
      alert.style.opacity = '0';
      setTimeout(() => alert.remove(), 500);
    }
  }, 4000);
});

</script>

              
        
        
</body>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script> <!-- Ajout de HTMX -->
<script src="{% static 'js/Flight.js' %}"></script>
{% endblock %}